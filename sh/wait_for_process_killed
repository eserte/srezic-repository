# Parameters:
# - process id (mandatory)
# - timeout (optional, defaults to 20s)
# Kills with signal 9.
# The checks for process existence are done every second
# except on linux systems where it's every 0.1s.
wait_for_process_killed () {
    local pid=$1
    local timeout=$2
    if [ -z $timeout ]; then timeout=20; fi;
    local step=1
    if [ "$OSTYPE" = "linux-gnu" ]; then step=0.1; fi
    local killsig=9

    kill -$killsig $pid;
    while kill -0 $pid 2>/dev/null
    do
        timeout=$((timeout-step))
        if [[ $timeout -le 0 ]]
        then
            echo "Process $pid still runs, cannot kill it"
            return 1
        fi
        sleep $step
    done
    return 0
}
